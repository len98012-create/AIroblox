name: Sentinel_SRE_Turbo_Speed

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  run-sentinel:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    permissions:
      contents: write
    
    env:
      XAUTHORITY: /home/runner/.Xauthority
      DISPLAY: :99
      PYTHONPATH: ${{ github.workspace }}/libs
      ROBLOX_COOKIE: ${{ secrets.ROBLOX_COOKIE }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      GEMINI_KEY_9: ${{ secrets.GEMINI_KEY_9 }}

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚ö° Turbo Cache Libs
        uses: actions/cache@v3
        with:
          path: libs
          key: sentinel-libs-v7-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            sentinel-libs-v7-${{ runner.os }}-

      - name: üõ†Ô∏è System Dependencies & Cleanup
        run: |
          # D·ªçn d·∫πp c√°c ti·∫øn tr√¨nh c≈© n·∫øu c√≥ (Tr√°nh l·ªói Port 9222)
          sudo pkill -9 chrome || true
          sudo pkill -9 chromium || true
          
          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends \
            chromium-browser xvfb fluxbox xauth scrot tesseract-ocr \
            python3-tk python3-dev libx11-dev > /dev/null
          
          mkdir -p libs memory/action_steps logs/screenshots extensions
          touch $XAUTHORITY
          xauth add :99 . $(mcookie)

      - name: üì¶ Python Core Install
        run: |
          # S·ª≠a l·ªói th·ª•t l·ªÅ t·ª´ b·∫£n g·ªëc c·ªßa b·∫°n
          pip install --target=libs google-genai flask requests pyautogui Pillow \
            selenium psutil pytesseract opencv-python-headless \
            webdriver-manager 

      - name: üöÄ Launch Sentinel v7.7
        run: |
          # 1. Kh·ªüi t·∫°o Display ·∫£o v·ªõi ƒë·ªô ph√¢n gi·∫£i chu·∫©n
          Xvfb :99 -screen 0 1280x720x24 -ac +extension RANDR > /dev/null 2>&1 &
          sleep 3
          fluxbox > /dev/null 2>&1 &
          
          # 2. Ch·∫°y Brain Service (Ng·∫ßm)
          if [ -f "brain_service/app.py" ]; then
            python3 -u brain_service/app.py > logs/brain.log 2>&1 &
            BRAIN_PID=$!
            echo "üß† Brain Service started (PID: $BRAIN_PID)"
          fi
          sleep 5
          
          # 3. Ch·∫°y Agent ch√≠nh (Foreground)
          if [ -f "sentinel_v35_dual_memory.py" ]; then
            echo "üöÄ Sentinel Agent is taking control..."
            python3 -u sentinel_v35_dual_memory.py 2>&1 | tee logs/agent_runtime.log
          else
            echo "‚ùå Critical Error: Agent file missing!"
            exit 1
          fi

          # 4. ƒê·ª£i Brain Service n·∫øu c·∫ßn
          [ -n "$BRAIN_PID" ] && wait $BRAIN_PID

      - name: üíæ State Persistence
        if: always()
        run: |
          git config --global user.name "Sentinel-Auto"
          git config --global user.email "bot@sentinel.io"
          
          # C∆∞·ª°ng b·ª©c l∆∞u l·∫°i to√†n b·ªô d·ªØ li·ªáu h·ªçc t·∫≠p v√† log
          git add -f memory/ logs/
          git commit -m "üíæ Auto-Save [Key 9]: $(date)" || echo "No changes to sync"
          git push origin main
