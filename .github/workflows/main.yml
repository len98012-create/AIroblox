
name: Sentinel_SRE_Turbo_Speed

on:
  workflow_dispatch:      # KÃ­ch hoáº¡t thá»§ cÃ´ng
  schedule:
    - cron: '0 */4 * * *' # Tá»± Ä‘á»™ng cháº¡y má»—i 4 tiáº¿ng

jobs:
  run-sentinel:
    runs-on: ubuntu-latest
    timeout-minutes: 350 
    permissions:
      contents: write    
    
    env:
      XAUTHORITY: /home/runner/.Xauthority
      DISPLAY: :99
      PYTHONPATH: ${{ github.workspace }}/libs
      ROBLOX_COOKIE: ${{ secrets.ROBLOX_COOKIE }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      GEMINI_KEY_9: ${{ secrets.GEMINI_KEY_9 }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: âš¡ Turbo Cache Libs
        uses: actions/cache@v3
        with:
          path: libs
          key: sentinel-libs-${{ runner.os }}-${{ hashFiles('**/app.py') }}
          restore-keys: |
            sentinel-libs-${{ runner.os }}-

      - name: ðŸ› ï¸ Instant Setup (Deep Fix)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends \
            chromium-browser xvfb fluxbox xauth scrot tesseract-ocr \
            python3-tk python3-dev libx11-dev libxext-dev libxrender-dev \
            libxtst-dev libpng-dev gnome-screenshot > /dev/null
          
          mkdir -p libs memory/action_steps logs/screenshots extensions
          
          touch $XAUTHORITY
          xauth add :99 . $(mcookie)

      - name: ðŸ“¦ Install Python Deps
        run: |
          # Use google-generativeai for better compatibility in custom lib folders
          if [ ! -d "libs/google" ]; then
            pip install -q -t libs \
              google-generativeai \
              flask \
              requests \
              pyautogui \
              Pillow \
              selenium \
              psutil \
              pytesseract \
              opencv-python-headless
          fi

      - name: ðŸš€ Turbo Run
        run: |
          # Start Xvfb with better depth
          Xvfb :99 -screen 0 1280x720x24 -ac +extension RANDR > /dev/null 2>&1 &
          sleep 3
          fluxbox > /dev/null 2>&1 &
          sleep 2
          
          # Start Brain Service
          python3 brain_service/app.py & 
          echo "ðŸ§  Brain Service Started..."
          sleep 5
          
          # Start Agent
          if [ -f "sentinel_v35_dual_memory.py" ]; then
            python3 sentinel_v35_dual_memory.py
          else
            echo "Error: sentinel_v35_dual_memory.py not found"
            exit 1
          fi

      - name: ðŸ’¾ Background Sync (Force Push)
        if: always()
        run: |
          git config --global user.name "Sentinel-Turbo"
          git config --global user.email "sre@sentinel.io"
          # Use -f to bypass .gitignore for logs/memory
          git add -f memory/ logs/ extensions/
          git commit -m "âš¡ Turbo Sync: $(date)" || echo "No changes"
          git push -f
