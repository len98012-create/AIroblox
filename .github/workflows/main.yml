name: Sentinel_SRE_Turbo_Speed

on:
  workflow_dispatch:      # K√≠ch ho·∫°t th·ªß c√¥ng b·∫±ng n√∫t Run
  schedule:
    - cron: '0 */4 * * *' # T·ª± ƒë·ªông ch·∫°y l·∫°i m·ªói 4 ti·∫øng ƒë·ªÉ duy tr√¨ li√™n t·ª•c

jobs:
  run-sentinel:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # Gi·ªõi h·∫°n an to√†n (t·ªëi ƒëa GitHub cho ph√©p l√† 360)
    permissions:
      contents: write    # C·∫•p quy·ªÅn ghi ƒë√® ƒë·ªÉ l∆∞u b·ªô nh·ªõ (Memory)
    
    env:
      XAUTHORITY: /home/runner/.Xauthority
      DISPLAY: :99
      PYTHONPATH: ${{ github.workspace }}/libs
      ROBLOX_COOKIE: ${{ secrets.ROBLOX_COOKIE }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      GEMINI_KEY_9: ${{ secrets.GEMINI_KEY_9 }}

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      # CACHE: Ch·ªâ cache th∆∞ m·ª•c libs ƒë·ªÉ tr√°nh l·ªói permission v·ªõi /var/cache/apt
      - name: ‚ö° Turbo Cache Libs
        uses: actions/cache@v3
        with:
          path: libs
          key: sentinel-libs-${{ runner.os }}-${{ hashFiles('**/app.py') }}
          restore-keys: |
            sentinel-libs-${{ runner.os }}-

      - name: üõ†Ô∏è Instant Setup (System)
        run: |
          # C√†i ƒë·∫∑t h·ªá th·ªëng (Th√™m tesseract-ocr cho Vision Core)
          sudo apt-get update -qq
          sudo apt-get install -y -qq --no-install-recommends \
            chromium-browser xvfb fluxbox xauth scrot tesseract-ocr > /dev/null
          
          # T·∫°o c·∫•u tr√∫c th∆∞ m·ª•c b·∫Øt bu·ªôc
          mkdir -p libs memory/action_steps logs/screenshots sentinel_agent/extensions
          
          # Thi·∫øt l·∫≠p m√†n h√¨nh ·∫£o
          touch $XAUTHORITY
          xauth add :99 . $(mcookie)

      - name: üì¶ Install Python Deps
        run: |
          if [ ! -d "libs/google" ]; then
            echo "Installing dependencies..."
            # L∆ØU √ù QUAN TR·ªåNG: D√πng 'google-genai' cho SDK m·ªõi
            pip install -q -t libs \
              google-genai \
              flask \
              requests \
              pyautogui \
              Pillow \
              selenium \
              psutil \
              pytesseract \
              opencv-python-headless
          else
            echo "‚ö° Cache hit! Skipping install."
          fi
      - name: üöÄ Turbo Run (Brain + Agent)
        run: |
          # 1. Kh·ªüi ch·∫°y GUI ·∫£o (Low Res ƒë·ªÉ t·ªëi ∆∞u t·ªëc ƒë·ªô x·ª≠ l√Ω ·∫£nh)
          Xvfb :99 -screen 0 1280x720x16 -auth $XAUTHORITY > /dev/null 2>&1 &
          fluxbox > /dev/null 2>&1 &
          sleep 2
          
          # 2. Kh·ªüi ch·∫°y Brain Service (Background)
          python3 brain_service/app.py & 
          echo "üß† Brain Service Started..."
          sleep 3
          
          # 3. Kh·ªüi ch·∫°y Agent (Foreground - Ch·∫∑n ti·∫øn tr√¨nh ƒë·ªÉ gi·ªØ Runner s·ªëng)
          echo "ü§ñ Launching Sentinel Dual Memory..."
          python3 sentinel_v35_dual_memory.py

      - name: üíæ Background Sync (Save Memory)
        if: always() # Lu√¥n ch·∫°y d√π code Python b·ªã Crash
        run: |
          git config --global user.name "Sentinel-Turbo"
          git config --global user.email "sre@sentinel.io"
          
          # Th√™m c√°c file quan tr·ªçng c·∫ßn l∆∞u
          git add memory/ logs/ sentinel_agent/extensions/
          
          # Commit v√† Force Push
          git commit -m "‚ö° Turbo Sync: $(date) - Self-Healing & Memory Update" || echo "No changes to sync"
          git pull --rebase --strategy-option=theirs # Tr√°nh xung ƒë·ªôt tr∆∞·ªõc khi push
          git push
