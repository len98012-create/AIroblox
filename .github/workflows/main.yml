name: Sentinel_SRE_Turbo_Speed

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  run-sentinel:
    runs-on: ubuntu-latest
    timeout-minutes: 350
    permissions:
      contents: write
    
    env:
      XAUTHORITY: /home/runner/.Xauthority
      DISPLAY: :99
      PYTHONPATH: ${{ github.workspace }}/libs
      ROBLOX_COOKIE: ${{ secrets.ROBLOX_COOKIE }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      GEMINI_KEY_9: ${{ secrets.GEMINI_KEY_9 }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install Google Chrome Stable & Graphics Fix
        run: |
          sudo pkill -9 chrome || true
          sudo pkill -9 chromium || true
          # ThÃªm Repo Google Chrome chÃ­nh thá»©c
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update -qq
          # CÃ i Ä‘áº·t Chrome Stable vÃ  cÃ¡c thÆ° viá»‡n render Ä‘á»“ há»a
          sudo apt-get install -y google-chrome-stable xvfb fluxbox scrot tesseract-ocr \
            python3-tk python3-dev libx11-dev libgl1-mesa-dri libglapi-mesa libosmesa6 mesa-utils
          
          mkdir -p libs memory/action_steps logs/screenshots extensions
          touch $XAUTHORITY
          xauth add :99 . $(mcookie)

      - name: ðŸ“¦ Python Core Install
        run: |
          pip install --upgrade --target=libs google-genai flask requests pyautogui Pillow \
            selenium psutil pytesseract opencv-python-headless \
            webdriver-manager

      - name: ðŸš€ Launch Sentinel v43.1
        run: |
          # 1. Khá»Ÿi táº¡o Display áº£o vá»›i tÃ­nh nÄƒng Render nÃ¢ng cao
          Xvfb :99 -screen 0 1280x720x24 -ac +extension RANDR +render -noreset > /dev/null 2>&1 &
          sleep 5
          
          # 2. Khá»Ÿi Ä‘á»™ng Window Manager
          fluxbox -display :99 > /dev/null 2>&1 &
          sleep 3
          
          # 3. Cháº¡y Agent chÃ­nh
          export DISPLAY=:99
          python3 -u sentinel_v35_dual_memory.py 2>&1 | tee logs/agent_runtime.log

      - name: ðŸ’¾ State Persistence
        if: always()
        run: |
          git config --global user.name "Sentinel-Auto"
          git config --global user.email "bot@sentinel.io"
          git add -f memory/ logs/
          git commit -m "ðŸ’¾ Auto-Save [Key 9]: $(date)" || echo "No changes"
          git push origin main
